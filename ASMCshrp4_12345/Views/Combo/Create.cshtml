@model ASMCshrp4_12345.ViewModels.ComboViewModel

@{
    ViewData["Title"] = "Thêm Combo";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<h2>Thêm Combo</h2>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label for="TenComBo">Tên Combo</label>
        <input type="text" class="form-control" id="TenComBo" name="TenComBo" required />
    </div>

    <div class="form-group">
        <label for="SoLuong">Số Lượng</label>
        <input type="number" class="form-control" id="SoLuong" name="SoLuong" required />
    </div>
    <div>
        <label for="HinhAnhList">Hình Ảnh:</label>
        <input asp-for="HinhAnhList" type="file" multiple />
    </div>
    <div>
        <label for="MoTa">Mô Tả:</label>
        <textarea asp-for="MoTa" class="form-control"></textarea> <!-- Trường nhập mô tả -->
    </div>
    <br />
    <!-- Nút mở modal chọn sản phẩm -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#selectProductsModal">
        Chọn Sản Phẩm
    </button>

    <!-- Modal chọn sản phẩm -->
    <div class="modal fade" id="selectProductsModal" tabindex="-1" aria-labelledby="selectProductsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectProductsModalLabel">Danh Sách Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Chọn</th>
                                <th>Mã Sản Phẩm</th>
                                <th>Tên Sản Phẩm</th>
                                <th>Giá Bán</th>
                                <th>Số Lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.SanPhamList.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <input type="checkbox"
                                               class="product-checkbox"
                                               data-masp="@Model.SanPhamList[i].MaSp"
                                               data-tensp="@Model.SanPhamList[i].TenSp"
                                               data-giaban="@Model.SanPhamList[i].GiaBan"
                                               onchange="toggleProduct(this)" />
                                    </td>
                                    <td>@Model.SanPhamList[i].MaSp</td>
                                    <td>@Model.SanPhamList[i].TenSp</td>
                                    <td>@Model.SanPhamList[i].GiaBan.ToString("N0") VND</td>
                                    <td>
                                        <input type="number"
                                               class="product-quantity form-control"
                                               data-masp="@Model.SanPhamList[i].MaSp"
                                               value="1"
                                               min="1"
                                               onchange="updateProductQuantity(this)" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bảng hiển thị sản phẩm đã chọn -->
    <h5>Các sản phẩm đã chọn:</h5>
    <table class="table" id="selectedProductsTable">
        <thead>
            <tr>
                <th>Mã Sản Phẩm</th>
                <th>Tên Sản Phẩm</th>
                <th>Số Lượng</th>
                <th>Thành Tiền</th>
            </tr>
        </thead>
        <tbody>
            <!-- Nội dung sẽ được cập nhật bởi JavaScript -->
        </tbody>
    </table>

    <!-- Hiển thị tổng giá gốc -->
    <h5>Tổng giá gốc: <span id="tongGiaGoc">0</span> VND</h5>

    <!-- Ẩn danh sách sản phẩm đã chọn để gửi về server -->
    <input type="hidden" id="SanPhamList" name="SanPhamList" />

    <div class="form-group">
        <label for="DonGia">Giá combo</label>
        <input type="number" class="form-control" id="DonGia" name="DonGia" required />
    </div>

    <button type="submit" class="btn btn-success mt-3">Lưu</button>
</form>

<script>
    // tạo cái danh sách sp đã chọn
    let selectedProducts = [];

    // cái này xử lí nút checkbox khi chọn hoặc bỏ
    function toggleProduct(checkbox) {
        const maSp = checkbox.getAttribute('data-masp');
        const tenSp = checkbox.getAttribute('data-tensp');
        const giaBan = parseFloat(checkbox.getAttribute('data-giaban'));
        const soLuongInput = document.querySelector(`.product-quantity[data-masp="${maSp}"]`);
        const soLuong = parseInt(soLuongInput.value) || 1;
        // checked bằng true thì thêm k thì thôi
        if (checkbox.checked) {
            selectedProducts.push({ maSp, tenSp, giaBan, soLuong, IsSelected: true });
        } else {
            selectedProducts = selectedProducts.filter(sp => sp.maSp !== maSp);
        }
        updateSelectedProductsTable();
    }
    // hàm để xử lí số lượng
    function updateProductQuantity(input) {
        const maSp = input.getAttribute('data-masp');
        const soLuong = parseInt(input.value) || 1;
        const product = selectedProducts.find(sp => sp.maSp === maSp);
        if (product) {
            product.soLuong = soLuong;
        }
        updateSelectedProductsTable();
    }
    //hàm render ra cái sản phẩm đã chọn
    function updateSelectedProductsTable() {
        const tableBody = document.getElementById('selectedProductsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        let tongGiaGoc = 0;

        selectedProducts.forEach(sp => {
            const thanhTien = sp.giaBan * sp.soLuong;
            tongGiaGoc += thanhTien;
            const row = `
                <tr>
                    <td>${sp.maSp}</td>
                    <td>${sp.tenSp}</td>
                    <td>${sp.soLuong}</td>
                    <td>${thanhTien.toLocaleString()} VND</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
        document.getElementById('tongGiaGoc').innerText = tongGiaGoc.toLocaleString();
        // Cập nhật dữ liệu gửi về server (qua controller lấy xuống rồi thêm)
        document.getElementById('SanPhamList').value = JSON.stringify(selectedProducts);
    }
    // hàm này kiểm tra lại cái mảng selectedProducts coi có dữ liệu không
    document.querySelector('form').addEventListener('submit', function(event) {
        if (selectedProducts.length === 0) {
            event.preventDefault();
            alert('Vui lòng chọn ít nhất một sản phẩm.');
        }
    });
    // Khi modal bị ẩn (ẩn modal thì cập nhật bảng)
    $('#selectProductsModal').on('hide.bs.modal', function () {
        updateSelectedProductsTable();
    });
</script>
