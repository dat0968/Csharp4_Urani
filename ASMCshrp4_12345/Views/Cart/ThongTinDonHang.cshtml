@model dynamic

<h3>Các đơn hàng trước đó</h3>

<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-choxacnhan-tab" data-bs-toggle="pill" data-bs-target="#pills-choxacnhan" type="button" role="tab" aria-controls="pills-choxacnhan" aria-selected="true">Chờ xác nhận</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-daxacnhan-tab" data-bs-toggle="pill" data-bs-target="#pills-daxacnhan" type="button" role="tab" aria-controls="pills-daxacnhan" aria-selected="false">Đã xác nhận</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-danggiao-tab" data-bs-toggle="pill" data-bs-target="#pills-danggiao" type="button" role="tab" aria-controls="pills-danggiao" aria-selected="false">Đang giao hàng</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-dagiao-tab" data-bs-toggle="pill" data-bs-target="#pills-dagiao" type="button" role="tab" aria-controls="pills-dagiao" aria-selected="false">Đã giao</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-dathanhtoan-tab" data-bs-toggle="pill" data-bs-target="#pills-dathanhtoan" type="button" role="tab" aria-controls="pills-dathanhtoan" aria-selected="false">Đã thanh toán</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-dahuy-tab" data-bs-toggle="pill" data-bs-target="#pills-dahuy" type="button" role="tab" aria-controls="pills-dahuy" aria-selected="false">Đã hủy</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-hoantien-tab" data-bs-toggle="pill" data-bs-target="#pills-hoantien" type="button" role="tab" aria-controls="pills-hoantien" aria-selected="false">Hoàn tiền</button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">
    <!-- Tab Chờ xác nhận -->
    <div class="tab-pane fade show active" id="pills-choxacnhan" role="tabpanel" aria-labelledby="pills-choxacnhan-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsChuaXacNhan)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                        <td>
                            <a asp-action="HuyDon" asp-controller="HuyDon_HoanTien" asp-route-id="@donHang.MaHoaDon" class="btn btn-primary ">Hủy đơn</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Tab Đã xác nhận -->
    <div class="tab-pane fade" id="pills-daxacnhan" role="tabpanel" aria-labelledby="pills-daxacnhan-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsDaXacNhan)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Tab Đang giao hàng -->
    <div class="tab-pane fade" id="pills-danggiao" role="tabpanel" aria-labelledby="pills-danggiao-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsDangGiao)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Tab Đã giao -->
    <div class="tab-pane fade" id="pills-dagiao" role="tabpanel" aria-labelledby="pills-dagiao-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsDaGiao)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Tab Đã thanh toán -->
    <div class="tab-pane fade" id="pills-dathanhtoan" role="tabpanel" aria-labelledby="pills-dathanhtoan-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsDaTT)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                        @if (DateTime.Now - (donHang.ThoiGianGiao.ToDateTime(new TimeOnly(0, 0))) < TimeSpan.FromDays(3))
                        {
                            <td><a asp-action="HoanTien" asp-controller="HuyDon_HoanTien" asp-route-id="@donHang.MaHoaDon" class="btn btn-primary">Hoàn tiền</a></td>
                        }
                        
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Tab Đã hủy -->
    <div class="tab-pane fade" id="pills-dahuy" role="tabpanel" aria-labelledby="pills-dahuy-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsDaHuy)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Tab hoàn tiền -->
    <div class="tab-pane fade" id="pills-hoantien" role="tabpanel" aria-labelledby="pills-hoantien-tab" tabindex="0">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>Địa Chỉ Nhận Hàng</th>
                    <th>Ngày Tạo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var donHang in Model.DonHangsHoanTien)
                {
                    <tr>
                        <td>@donHang.MaHoaDon</td>
                        <td>@donHang.DiaChiNhanHang</td>
                        <td>@donHang.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td><button class="btn btn-primary xemChiTietDonHang" data-mahoadon="@donHang.MaHoaDon">Chi tiết đơn hàng</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<div class="modal" id="chiTietDonHangModal" tabindex="-1" aria-labelledby="chiTietDonHangLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chiTietDonHangLabel">Chi tiết đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="chiTietDonHangContent">
                    <!-- Nội dung được load từ server -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('.xemChiTietDonHang').on('click', function () {
            const maHoaDon = $(this).data('mahoadon'); // Lấy mã hóa đơn

            $.ajax({
                url: '/Cart/ChiTietDonHang', // Action để lấy dữ liệu
                method: 'GET',
                data: { maHoaDon: maHoaDon },
                success: function (response) {
                    // Chỉ cập nhật nội dung modal-content
                    $('#chiTietDonHangContent').html(response);
                    $('#chiTietDonHangModal').modal('show');
                },
                error: function () {
                    $('#chiTietDonHangContent').html('<p class="text-danger">Không thể tải dữ liệu chi tiết đơn hàng.</p>');
                }
            });
        });
    });
</script>